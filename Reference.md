# x68kzremotedrv リファレンスドキュメント

x68kzremotedrv で提供されるコマンド、デバイスドライバ等の利用方法を説明します。

## zremote コマンド

### 概要

zremote.x はリモートドライブの設定変更を Human68k 上から行うためのコマンドです。
リモートドライブから起動する場合は、起動時に F1 キーを押すことで設定変更メニューが立ち上がりますが、USB メモリとリモートドライブを併用する場合や Human68k の起動後に設定を変更したい時に利用できます。

zremote.x は、設定の変更を設定変更メニュー画面からとコマンドラインオプションからの二通りの方法で行うことができます(FORMAT.X などのシャープ純正コマンドと同様の使い方です)。

### メニュー画面からの実行

zremote.x をコマンドラインオプションなしで起動すると、設定用メニュー画面で設定変更を行うことができます。

```
zremote
```

実行すると、「サーバ設定画面」「リモート設定画面」のどちらかのメニュー画面が表示されます。

* サーバ設定画面
  * WiFi 設定や Windows ファイル共有サーバの設定など、リモートドライブの接続に必要な基本的な設定を行う画面です。zremote 実行時にこれらの設定が完了していない場合にはこの画面が表示されます。
* リモート設定画面
  * リモートディレクトリやリモートイメージの設定を行う画面です。サーバ設定が完了している場合はこの画面が表示されます。

設定項目間はカーソルキーで移動でき、リターンキーで選択中の項目の設定を行います。また、ESC キーでメニュー画面を終了します。

画面下の「リモート設定へ」「サーバ設定へ」を選択することで、設定画面間を切り替えることができます。


#### サーバ設定画面
```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Ｒｅｍｏｔｅ　Ｄｒｉｖｅ　Ｓｅｒｖｉｃｅ　ｆｏｒ　Ｘ６８０００ Ｚ  Version xxxxxxxx  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    基本設定
  ┏━━━━━┳━━━━━━━━━━━━━━┓
  ┃BOOTMODE  ┃リモートディレクトリから起動┃
  ┗━━━━━┻━━━━━━━━━━━━━━┛
    WiFi 設定                         未接続
  ┏━━━━━┳━━━━━━━━━━━━━━┓
  ┃SSID      ┃xxxxxx                      ┃
  ┃PASSWORD  ┃********                    ┃
  ┗━━━━━┻━━━━━━━━━━━━━━┛
    Windows ファイル共有設定          未接続
  ┏━━━━━┳━━━━━━━━━━━━━━┓
  ┃USERNAME  ┃xxxxxx                      ┃
  ┃PASSWORD  ┃********                    ┃
  ┃WORKGROUP ┃WORKGROUP                   ┃
  ┃SERVER    ┃xx.xx.xx.xx                 ┃
  ┗━━━━━┻━━━━━━━━━━━━━━┛
    時刻同期設定
  ┏━━━━━┳━━━━━━━━━━━━━━┓
  ┃TZ        ┃JST-9                       ┃
  ┃TADJUST   ┃2                           ┃
  ┗━━━━━┻━━━━━━━━━━━━━━┛

  ┏━━━━━━━━┓                                                     ┏━━━━━┓
  ┃ リモート設定へ ┃                                                     ┃設定クリア┃
  ┗━━━━━━━━┛                                                     ┗━━━━━┛
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                                                                      ┃
┃                                                                                      ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

以下の設定項目があります。

* 基本設定
  * x68kzremotedrv の動作を「リモートディレクトリから起動」「リモートイメージから起動」「USB メモリから起動」のいずれかから選択します
* WiFi 設定
  * WiFi 接続のアクセスポイントを設定します
  * 「SSID」を選択すると WiFi をスキャンして見つかったアクセスポイントのリストを表示するので、リスト中から選択するか SSID 名を直接キーボードから入力します
  * 「PASSWORD」を選択するとアクセスポイントのパスワードを入力できます。パスワードは通常 "*" でマスクされていますが、TAB を押すと表示とマスクを切り替えることができます
  * パスワードを入力するとアクセスポイントへの接続を開始します。接続完了すると「未接続」の表示が「接続済」に変わります
* Windows ファイル共有設定 (WiFi 設定が完了していないと表示されません)
  * 接続先の Windows ファイル共有 (SMB) サーバを設定します
  * 「USERNAME」「PASSWORD」「WORKGROUP」「SERVER」にはそれぞれ、接続先サーバのユーザ名(ローカルアカウント)、接続パスワード、ワークグループ、サーバ名または IP アドレス、を指定します
  * サーバ名または IP アドレスを入力するとファイル共有サーバへの接続を開始します。接続完了すると「未接続」の表示が「接続済」に変わります
* 時刻同期設定
  * X68000 Z の時刻をファイル共有サーバの時刻に合わせるための設定を行います
  * 「TZ」にはサーバから取得した時刻のタイムゾーン文字列を設定します。通常はデフォルトの "JST-9" のままで大丈夫です。
  * 「TADJUST」にはサーバから取得した時刻を X68000 Z に設定する際のオフセット値(秒数)を設定します。通常はデフォルトの 2 で大丈夫ですが、サーバとの時刻同期が不要な場合は 0 を設定します
* リモート設定へ (Windows ファイル共有設定が完了していないと表示されません)
  * メニュー画面をリモート設定画面に切り替えます
* 設定クリア
  * 設定内容をすべてクリアします

#### リモート設定画面
```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Ｒｅｍｏｔｅ　Ｄｒｉｖｅ　Ｓｅｒｖｉｃｅ　ｆｏｒ　Ｘ６８０００ Ｚ  Version xxxxxxxx  ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
    リモートディレクトリ設定
  ┏━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
  ┃RMTUNIT   ┃1                                                                       ┃
  ┃#0 (A:)   ┃xxxx/xxxx/                                                              ┃
  ┗━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛







    リモートイメージ設定
  ┏━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
  ┃INGUNIT   ┃1                                                                       ┃
  ┃#0 (B:)   ┃xxxx/xxxx/xxxx.HDS                                                      ┃
  ┗━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛





  ┏━━━━━┓                                                     ┏━━━━━━━━┓
  ┃ 設定終了 ┃                                                     ┃  サーバ設定へ  ┃
  ┗━━━━━┛                                                     ┗━━━━━━━━┛
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                                                                                      ┃
┃                                                                                      ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

以下の設定項目があります。

* リモートディレクトリ設定
  * リモートディレクトリの接続先を設定します
  * 「RMTUNIT」にはリモートディレクトリのユニット数を 0 ～ 8 の値で指定します。0 の場合はリモートディレクトリは使用しません
  * 「#0」 ～ 「#7」(最大値はRMTUNITの値による)には、そのユニット番号のリモートディレクトリの接続先を指定します
    * 既にそのユニット番号での接続があってドライブ名が割り当てられている場合は、ドライブ名も表示されます
    * 選択すると接続済みのファイル共有サーバで利用可能な共有名一覧が表示されるので、接続先を選択してディレクトリをたどり、設定したいディレクトリで "." を選択します
* リモートイメージ設定
  * リモートイメージの接続先を設定します
  * 基本設定の BOOTMODE が「リモートイメージから起動」だった場合は、この項目はリモートディレクトリ設定より上に表示されます
  * 「IMGUNIT」にはリモートイメージのユニット数を 0 ～ 4 の値で指定します。0 の場合はリモートイメージは使用しません
  * 「#0」 ～ 「#3」(最大値はIMGUNITの値による)には、そのユニット番号のリモートイメージの接続先を指定します
    * 既にそのユニット番号での接続があってドライブ名が割り当てられている場合は、ドライブ名も表示されます
    * 選択すると接続済みのファイル共有サーバで利用可能な共有名一覧が表示されるので、接続先を選択してディレクトリをたどり、設定したいイメージファイルを選択します
* サーバ設定へ
  * メニュー画面をサーバ設定画面に切り替えます
* 設定終了
  * zremote コマンドを終了します。これまでの設定内容を登録してから終了するか、登録せずに終了するかを選択します。


### コマンドラインからの実行

zremote コマンド実行時にコマンドラインオプションを指定すると、メニュー画面に入らずに設定変更を行います。

```
zremote [サブコマンド] [オプション...]
```

以下のサブコマンドが指定できます。

* mount    -- リモートディレクトリ/イメージの接続設定
* umount   -- リモートディレクトリ/イメージの接続解除
* wifi     -- WiFiアクセスポイントへの接続設定
* server   -- Windowsファイル共有サーバへの接続設定
* bootmode -- 起動モードの設定
* imgscsi  -- リモートイメージの接続モード設定
* erase    -- 保存されている設定内容の全消去
* stat     -- 現在の設定内容一覧表示

`-h` オプションを指定すると、サブコマンド一覧や特定のサブコマンドの説明が表示されます。

```
zremote -h                  -- サブコマンド一覧の表示
zremote [サブコマンド] -h    -- 指定したサブコマンドの説明を表示
```

#### zremote mount -- リモートディレクトリ/イメージの接続設定

```
zremote mount                          -- リモートディレクトリ/イメージの接続状態を表示
zremote mount ドライブ名:               -- 指定したドライブの接続状態を表示
zremote mount ドライブ名: リモートパス名 -- 指定したドライブにリモートディレクトリ/イメージを接続
zremote mount -D ドライブ名:            -- リモートディレクトリ/イメージの接続を解除
zremote mount -n ユニット数             -- リモートディレクトリのユニット数を設定
zremote mount -m ユニット数             -- リモートイメージのユニット数を設定
```

* オプションを指定せず `zremote mount` を実行すると、リモートディレクトリ/イメージの現在の接続状態を表示します
* ドライブ名のみ指定して `zremote mount ドライブ名:` を実行すると、指定したドライブ名のドライブの現在の接続状態を表示します。ドライブ名はリモートドライブでなければなりません
* `zremote mount ドライブ名: リモートパス名` で、指定したドライブ名のドライブにリモートディレクトリまたはリモートイメージを接続します
* `zremote mount -D` で指定したドライブ名のドライブへの接続を解除します。`zremote umount ドライブ名:` と同じです
* `zremote mount -n` は、リモートディレクトリのユニット数を 0～8 の値で指定します
* `zremote mount -m` は、リモートイメージのユニット数を 0～4 の値で指定します

`-n`、`-m` オプションの設定変更を反映するには再起動が必要です。

#### zremote umount -- リモートディレクトリ/イメージの接続解除

```
zremote umount ドライブ名:
```

* 指定したドライブ名のドライブへの接続を解除します。ドライブ名はリモートドライブでなければなりません。


#### zremote wifi -- WiFiアクセスポイントへの接続設定

```
zremote wifi                       -- WiFiアクセスポイントの接続状態を表示
zremote wifi -l                    -- 接続可能なWiFiアクセスポイントのリストを表示
zremote wifi <SSID> [-p パスワード] -- WiFiアクセスポイントへの接続
```

* オプションを指定せず `zremote wifi` を実行すると、WiFi アクセスポイントの現在の接続状態を表示します
* `zremote wifi -l` で、接続可能な WiFi アクセスポイントのリストを表示します
* `zremote wifi <SSID>` で、指定した SSID の WiFi アクセスポイントへ接続します
  * `-p パスワード` -- 指定したパスワードを接続時に使用します。`-p` オプションを指定しない場合は接続時にパスワードの入力を促します

#### zremote server -- Windowsファイル共有サーバへの接続設定

```
zremote server                                     -- サーバの接続状態を表示
zremote server -l                                  -- 利用可能な共有名のリストを表示
zremote server -s                                  -- サーバとの時刻同期
zremote server -t オフセット [-z タイムゾーン文字列] -- 時刻同期設定
zremote server サーバ名 ユーザ名 [ワークグループ名] [-p パスワード] -- ファイル共有サーバへの接続
```

* オプションを指定せず `zremote server` を実行すると、Windows ファイル共有サーバの現在の接続状態を表示します
* `zremote server -l` で、Windows ファイル共有サーバへの接続が確立している時にそのサーバで利用可能な共有名のリストを表示します
* `zremote server -s` で、X68000 Z の時刻をサーバの時刻に同期します
* `zremote server -t` で、Windows ファイル共有サーバとの時刻同期の有無を設定します
  * オフセット -- サーバから取得した時刻を X68000 Z に設定する際のオフセット値を設定します。サーバとの時刻同期が不要な場合は 0 を設定します
  * `-z タイムゾーン文字列` -- サーバから取得した時刻のタイムゾーン文字列を設定します
* `zremote server サーバ名 ユーザ名` で、指定したサーバ名の Windows ファイル共有サーバに指定したユーザ名で接続します
  * ワークグループ名を省略すると "WORKGROUP" が用いられます
  * `-p パスワード` -- 指定したパスワードを接続時に使用します。`-p` オプションを指定しない場合は接続時にパスワードの入力を促します

#### zremote bootmode -- 起動モードの設定

```
zremote bootmode [0|1|2]
```

X68000 Z エミュレータの起動をどこから行うのかの起動モードを設定します。オプション指定を省略すると、現在の設定状態を表示します。

* 0 -- 起動をリモートディレクトリから行います
* 1 -- 起動をリモートイメージから行います
* 2 -- 起動を USB メモリから行います
  * X68000 Z エミュレータが pSCSI 機能による起動のために参照する `X68000Z/pscsi.ini` ファイルがラズパイ Pico W のドライブから見えなくなります。
    リモートドライブと USB メモリを併用する際に、USB ポートへの接続順によってリモート側からの起動に変わってしまうことを防ぎます。

この設定を変更した後は再起動が必要です。

#### zremote imgscsi -- リモートイメージの接続モード設定

```
zremote imgscsi [on|off]
```

リモートイメージ (HDSファイル) へのアクセス方法を以下のどちらで行うかを設定します。オプション指定を省略すると、現在の設定状態を表示します。

* off -- リモートイメージドライバモード (デフォルト値)
  * リモートの共有ファイルをイメージファイルとしてアクセスする、専用ドライバを用いて起動します
  * USB メモリ起動との併用が可能です。起動ドライブの CONFIG.SYS で zremoteimg.sys を指定して組み込む必要があります
  * 使用中にイメージファイルの変更が可能です。SCSI MO ドライブのように運用することができます
* on -- 純正 SCSI ドライバモード
  * USB メモリと同様に、HDS ファイル内の埋め込み SCSI ドライバを用いて起動します
  * USB メモリ起動と併用することはできません。リモートドライブのみでの運用となります
  * イメージファイルの変更などの設定変更を行った場合は再起動が必要です

この設定を変更した後は再起動が必要です。

#### zremote erase -- 保存されている設定内容の全消去

```
zremote erase
```

ラズパイ Pico W 内に保存されている設定内容を全消去します。
実行すると「保存されている設定内容を全消去します。よろしいですか? (y/n):」と表示されるので、`y` を入力すると実行します。

リモートドライブ用に使用しているラズパイ Pico W には WiFi 接続用のパスワードなどが保存されているので、Pico W を他の目的に使用する際などに設定内容全消去を行います。

#### zremote stat -- 現在の設定内容一覧表示

```
zremote stat
```

現在の設定内容一覧を表示します。

表示例:
```
[起動モード]
リモートディレクトリから起動
[WiFi]
接続状態:接続済
SSID:xxxx
[ファイル共有サーバ]
接続状態:接続済
ファイル共有サーバ:xxxx ユーザ名:x68k ワークグループ:WORKGROUP
時刻同期設定: 2 (JST-9)
[リモートディレクトリ]
A: X68000Z/HFS
[リモートイメージ]
B: X68000Z/SCSIHDD81M.HDS
```


## リモートドライブデバイスドライバ

x68kzremotedrv でリモートディレクトリやリモートイメージにアクセスするためにはデバイスドライバが必要ですが、起動方法によって組み込まれ方が異なります。

### リモートドライブからの起動

リモートにあるシステムファイルや SCSI ディスクイメージから起動する場合は、接続に使用するラズパイ Pico W がデバイスドライバを提供します。特別な設定は必要ありません。

### ローカルドライブから起動してリモートドライブを併用

USB メモリ上の SCSI ディスクイメージなど、ローカルのドライブから起動して起動後の環境がリモートドライブも使用する場合は、起動用のローカルドライブにリモートドライブアクセスのためのデバイスドライバを組み込む必要があります。　

* zremotedrv.sys -- リモートディレクトリデバイスドライバ
* zremoteimg.sys -- リモートイメージデバイスドライバ

起動するシステムディスクの任意のディレクトリにデバイスドライバをコピーして、CONFIG.SYS ファイルに

```
DEVICE = [インストール先]\zremotedrv.sys
DEVICE = [インストール先]\zremoteimg.sys
```

のように設定して再起動することで、リモートドライブを利用できるようになります。オプションはありません。

ドライブの設定がない場合や起動時にラズパイ Pico W が接続されていない場合は、ドライバの組み込みを行いません。


## ラズパイ Pico W ディレクトリ構成

リモートドライブ用ファームウェアを書き込んだラズパイ Pico W は、USB マスストレージと専用リモートサービスの複合デバイスとして認識されます。

PC 等に接続すると、ボリュームラベル「X68Z REMOTE」のドライブとして認識されます。以下のような内容になっています。

* config.txt -- 設定内容保持用ファイル
  * 現在のリモートドライブ設定内容がテキストファイルとして読み出せます
    * (WiFiおよびWindowsファイル共有パスワードは `********` としてマスクされています)
  * このファイルを保存したり書き戻したりすることで、設定内容の保存と復元ができます
    * パスワードは `********` を書き換えることで保存・復元可能ですが、平文のままなので取り扱いには注意してください
* index.html -- [x68kzremotedrv](https://github.com/yunkya2/x68kzremotedrv)へのリダイレクト
* log.txt -- リモートサービスのログ出力
* README.txt -- 簡易説明
* zremotetools.xdf リモートサービスツール用FDイメージ
  * リモートディレクトリやリモートイメージにアクセスするためのドライバの入ったFDイメージ(XDFファイル)です。
  * このファイルをPC上でSDカードの X68000Z/ ディレクトリにコピーして X68000 Z に挿入することで、初回のドライバインストールに用いることができます。
  * FD イメージには以下のファイルが入っています。
    * zremote.x -- リモートドライブ設定用コマンド
    * zremotedrv.sys -- リモートディレクトリデバイスドライバ
    * zremoteimg.sys -- リモートイメージデバイスドライバ
* erase/
  * erase_all.txt -- ファームウェア完全消去用ファイル
  * erase_config.txt -- 設定内容全消去用ファイル
    * PC 上で各テキストファイルを開いて上書き保存することで、設定内容やファームウェアの消去ができます。
* X68000Z/
  * pscsi.ini -- pSCSI 起動用設定ファイル
  * image/
    * zremotedrv.hds -- リモートディレクトリ用ディスクイメージ
    * zremoteimg.hds -- リモートイメージ用ディスクイメージ (リモートイメージドライバ用)
    * scsiimg?.hds -- リモートイメージ用ディスクイメージ (純正SCSIドライバ用)
  * X68000 Z の Pseudo SCSI 起動に用いる設定ファイルと SCSI ディスクイメージです
  * リモートドライブの設定内容によってファイル構成が変化します。

